<!-- =========================
     admin.html (MICROTEXTOS + FIX setActivo ROBUSTO, SIN NUEVA L√ìGICA FUNCIONAL)
     Nota: Solo se mejora copy y se hace setActivo robusto para evitar "viaje no encontrado".
     ========================= -->
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>ComVi - Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  body { font-family: Arial, sans-serif; background: #f5f5f5; margin: 0; }
  header { background: #222; color: white; padding: 12px; text-align: center; }

  .card {
    background: white; margin: 10px; padding: 12px; border-radius: 10px;
    box-shadow: 0 0 4px rgba(0,0,0,.1);
  }

  .muted { font-size: 12px; color: #666; }
  .row { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .badges { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
  .badge { font-size:12px; padding:4px 8px; background:#f1f3f5; border-radius:999px; }

  button {
    padding: 8px 10px;
    border: none;
    border-radius: 8px;
    background: #0d6efd;
    color: white;
    cursor: pointer;
    margin-right: 6px;
    margin-top: 6px;
  }
  button.green { background:#198754; }
  button.gray { background:#6c757d; }
  button.red { background:#dc3545; }

  input, select, textarea {
    width: 100%;
    padding: 10px;
    margin: 6px 0;
    border-radius: 8px;
    border: 1px solid #ccc;
    box-sizing: border-box;
  }
  textarea { min-height: 80px; resize: vertical; }

  .hr { height: 1px; background: #eee; margin: 10px 0; }

  .estadoPend { color:#b26a00; font-weight:bold; }
  .estadoGest { color:#198754; font-weight:bold; }
</style>
</head>

<body>

<header>
  <h3 style="margin:0;">ComVi - Panel Admin</h3>
  <div class="muted" style="color:#bbb;">Contactos ¬∑ gesti√≥n ¬∑ edici√≥n</div>
</header>

<div class="card" id="metricas">Cargando m√©tricas...</div>
<div class="card">
  <div style="font-size:14px;">
    üß≠ <strong>Modo comunidad:</strong> ac√° solo conectamos personas sin publicar tel√©fonos.
    El chofer gestiona asientos desde su link privado.
  </div>
  <div class="muted" style="margin-top:6px;">
    Tip: ‚Äúüì≤ Enviar al chofer‚Äù abre WhatsApp con el link de control del viaje.
  </div>
</div>
<div id="listaContactos"></div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
/* ===============================
   GATE ADMIN (PIN SIMPLE MVP)
================================ */
(function gateAdmin() {
  const ok = localStorage.getItem("comvi_admin_ok");
  if (ok === "1") return;

  const pin = prompt("Admin PIN:");
  // CAMBI√Å ESTE PIN
  if (pin !== "2296") {
    document.body.innerHTML = "<div style='padding:16px;font-family:Arial'>Acceso denegado</div>";
    throw new Error("No autorizado");
  }
  localStorage.setItem("comvi_admin_ok", "1");
})();

/* ===============================
   SUPABASE
================================ */
const SUPABASE_URL = "https://amwokcrudsupfkpgyxia.supabase.co";
const SUPABASE_KEY = "sb_publishable_ZuUe5CTChHQwW5M3qldKqw_zU4MO0qM";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let CONTACTOS_CACHE = [];
let VIAJES_MAP = new Map(); // id -> viaje

/* ===============================
   FECHA LOCAL (evita corrimientos)
================================ */
function toLocalISOString(dateStr, timeStr) {
  const d = new Date(`${dateStr}T${timeStr}:00`);
  const pad = n => String(n).padStart(2, "0");
  const tz = -d.getTimezoneOffset(); // minutes
  const sign = tz >= 0 ? "+" : "-";
  const hh = pad(Math.floor(Math.abs(tz) / 60));
  const mm = pad(Math.abs(tz) % 60);
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}:00${sign}${hh}:${mm}`;
}

function fmtFecha(fechaISO) {
  return new Date(fechaISO).toLocaleString("es-AR", { dateStyle:"short", timeStyle:"short" });
}
function toDateInputValue(fechaISO) {
  const d = new Date(fechaISO);
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
}
function toTimeInputValue(fechaISO) {
  const d = new Date(fechaISO);
  const hh = String(d.getHours()).padStart(2,'0');
  const mi = String(d.getMinutes()).padStart(2,'0');
  return `${hh}:${mi}`;
}

function limpiarTelefonoAR(telefono) {
  let tel = (telefono ?? "").toString().trim();
  tel = tel.replace(/\D/g, "");
  if (!tel) return "";

  if (tel.startsWith("00")) tel = tel.slice(2);
  if (tel.startsWith("0")) tel = tel.slice(1);

  if (!tel.startsWith("54")) tel = "54" + tel;
  if (!tel.startsWith("549")) tel = tel.replace(/^54/, "549");

  return tel;
}

function esPendienteEstado(estado) {
  return (estado === "pendiente" || estado === "nuevo" || estado === null || estado === undefined || estado === "");
}

function escapeHtml(str) {
  return (str || "").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

/* ===============================
   METRICAS
================================ */
async function cargarMetricas() {
  const m = document.getElementById("metricas");

  const [vis, viajesAct, contTot, contPend] = await Promise.all([
    sb.from("visitas").select("*", { count: "exact", head: true }),
    sb.from("viajes").select("*", { count: "exact", head: true }).eq("activo", true),
    sb.from("contactos").select("*", { count: "exact", head: true }),
    sb.from("contactos").select("*", { count: "exact", head: true }).in("estado", ["nuevo","pendiente"])
  ]);

  if (vis.error || viajesAct.error || contTot.error || contPend.error) {
    console.error(vis.error, viajesAct.error, contTot.error, contPend.error);
    m.innerHTML = "<strong>M√©tricas</strong><br><span class='muted'>Error cargando m√©tricas</span>";
    return;
  }

  const total = contTot.count ?? 0;
  const pend = contPend.count ?? 0;
  const gest = total - pend;

  m.innerHTML = `
    <strong>M√©tricas</strong><br>
    Visitas: <strong>${vis.count ?? 0}</strong> ¬∑
    Viajes activos: <strong>${viajesAct.count ?? 0}</strong> ¬∑
    Contactos: <strong>${total}</strong>
    <span class="muted">(Pend: ${pend} ¬∑ Resueltos: ${gest})</span>
  `;
}

/* ===============================
   CONTACTOS / VIAJES
================================ */
async function cargarContactos() {
  const { data: contactos, error } = await sb
    .from("contactos")
    .select("*")
    .order("created_at", { ascending: false });

  if (error) {
    alert("Error cargando contactos");
    console.error(error);
    return;
  }

  CONTACTOS_CACHE = contactos || [];

  const viajeIds = Array.from(new Set(CONTACTOS_CACHE.map(c => c.viaje_id).filter(Boolean)));

  VIAJES_MAP = new Map();
  if (viajeIds.length > 0) {
    const { data: viajes, error: errV } = await sb
      .from("viajes")
      .select("*")
      .in("id", viajeIds);

    if (errV) {
      alert("Error cargando viajes");
      console.error(errV);
      return;
    }

    for (const v of (viajes || [])) VIAJES_MAP.set(v.id, v);
  }
  renderContactos();
}

/* ===============================
   ACCIONES
================================ */
function getContacto(id) {
  return CONTACTOS_CACHE.find(x => x.id === id);
}

function getChoferManageLink(v) {
  const base = window.location.href.replace(/admin\.html.*$/,"");
  const viaje = encodeURIComponent(v.id);
  const token = encodeURIComponent(v.edit_token || "");
  return `${base}chofer.html?viaje=${viaje}&token=${token}`;
}

function hablarChofer(contactoId) {
  const c = getContacto(contactoId);
  if (!c) { alert("Contacto no encontrado. Recarg√° la p√°gina."); return; }

  const v = VIAJES_MAP.get(c.viaje_id);
  if (!v) { alert("Viaje no encontrado. Recarg√° la p√°gina."); return; }

  const tel = limpiarTelefonoAR(v.telefono);
  if (!tel || tel.length < 10) {
    console.error("Telefono invalido:", v.telefono, "->", tel);
    alert("El viaje no tiene un tel√©fono v√°lido del chofer.");
    return;
  }

  if (!v.edit_token) {
    console.error("Viaje sin edit_token:", v);
    alert("Este viaje no tiene edit_token. Revis√° que se guarde al publicar.");
    return;
  }

  const fecha = fmtFecha(v.fecha_hora);
  const precioTxt = (v.precio === null || v.precio === undefined) ? "A convenir" : `$${v.precio}`;
  const linkChofer = getChoferManageLink(v);

  const texto =
    "Hola! Te contacto por un viaje publicado en ComVi.\n\n" +
    `${v.origen} -> ${v.destino}\n` +
    `Fecha y hora: ${fecha}${v.hora_aprox ? " (aprox)" : ""}\n` +
    `Asientos libres: ${v.asientos ?? "-"}\n` +
    `Precio: ${precioTxt}\n` +
    `Detalles: ${v.comentario ?? "-"}\n\n` +
    "üîê Link privado para gestionar el viaje:\n" +
    `${linkChofer}\n\n` +
    `ID viaje: ${v.id} - ID contacto: ${c.id}`;

  const url = `https://wa.me/${tel}?text=${encodeURIComponent(texto)}`;
  const w = window.open(url, "_blank");
  if (!w) alert("Popup bloqueado. Habilit√° popups para este sitio.");
}

async function marcarResuelto(contactoId) {
  const { error } = await sb
    .from("contactos")
    .update({ estado: "gestionado" })
    .eq("id", contactoId);

  if (error) {
    alert("Error actualizando estado");
    console.error(error);
    return;
  }

  await cargarMetricas();
  await cargarContactos();
}

function renderContactos() {
  const cont = document.getElementById("listaContactos");
  cont.innerHTML = "";

  if (!CONTACTOS_CACHE.length) {
    cont.innerHTML = `<div class="card">Todav√≠a no hay contactos.</div>`;
    return;
  }

  for (const c of CONTACTOS_CACHE) {
    const v = VIAJES_MAP.get(c.viaje_id);
    if (!v) continue;

    const pendiente = esPendienteEstado(c.estado);
    const estadoHtml = pendiente
      ? `<span class="estadoPend">Pendiente</span>`
      : `<span class="estadoGest">Resuelto</span>`;

    const activo = (v.activo === undefined || v.activo === null) ? true : !!v.activo;
    const pubTxt = activo ? "Activa" : "Pausada";
    const precioTxt = (v.precio === null || v.precio === undefined) ? "A convenir" : `$${v.precio}`;

    const div = document.createElement("div");
    div.className = "card";

    div.innerHTML = `
      <strong>${escapeHtml(v.origen)} -> ${escapeHtml(v.destino)}</strong><br>
      Hora: ${fmtFecha(v.fecha_hora)} ${v.hora_aprox ? `<span class="muted">(aprox)</span>` : ""}<br>

      <div class="badges">
        <span class="badge">Contacto: ${estadoHtml}</span>
        <span class="badge">Publicaci√≥n: <strong>${pubTxt}</strong></span>
        <span class="badge">Asientos: ${v.asientos ?? "-"}</span>
        <span class="badge">Precio: ${precioTxt}</span>
      </div>

      ${v.equipaje ? `<div class="muted">Equipaje: ${escapeHtml(v.equipaje)}</div>` : ""}
      ${v.comentario ? `<div style="margin-top:6px;">Detalles: ${escapeHtml(v.comentario)}</div>` : ""}

      <div style="margin-top:10px;">
        <button onclick="hablarChofer('${c.id}')">üì≤ Enviar al chofer</button>

        ${pendiente
          ? `<button class="green" onclick="marcarResuelto('${c.id}')">‚úÖ Listo (ya avis√©)</button>`
          : ""
        }

        ${activo
          ? `<button class="red" onclick="setActivo('${v.id}', false)">Pausar</button>`
          : `<button class="green" onclick="setActivo('${v.id}', true)">Reactivar</button>`
        }

        <button class="gray" onclick="toggleEdit('${v.id}')">Editar viaje</button>
        <button class="gray" onclick="ocultarViaje('${v.id}')">üßπ Ocultar viaje</button>
      </div>

      <div id="edit_${v.id}" style="display:none;">
        <div class="hr"></div>

        <div class="row">
          <div>
            <label class="muted">Fecha</label>
            <input type="date" id="fecha_${v.id}" value="${toDateInputValue(v.fecha_hora)}">
          </div>
          <div>
            <label class="muted">Hora</label>
            <input type="time" id="hora_${v.id}" value="${toTimeInputValue(v.fecha_hora)}">
          </div>
        </div>

        <label class="muted">
          <input type="checkbox" id="aprox_${v.id}" ${v.hora_aprox ? "checked" : ""}>
          Horario aproximado
        </label>

        <div class="row">
          <div>
            <label class="muted">Asientos libres</label>
            <input type="number" min="0" id="asientos_${v.id}" value="${v.asientos ?? 0}">
          </div>
          <div>
            <label class="muted">Precio</label>
            <input type="number" min="0" id="precio_${v.id}" value="${v.precio ?? ""}" ${(v.precio === null || v.precio === undefined) ? "disabled" : ""}>
            <label class="muted" style="display:block;margin-top:6px;">
              <input type="checkbox" id="aconvenir_${v.id}" ${(v.precio === null || v.precio === undefined) ? "checked" : ""} onchange="
                const p=document.getElementById('precio_${v.id}');
                p.disabled=this.checked;
                if(this.checked) p.value='';
              ">
              A convenir
            </label>
          </div>
        </div>

        <label class="muted">Equipaje</label>
        <select id="equipaje_${v.id}">
          <option value="" ${!v.equipaje ? "selected" : ""}>(sin especificar)</option>
          <option value="mochila" ${v.equipaje==="mochila" ? "selected" : ""}>mochila</option>
          <option value="bolso" ${v.equipaje==="bolso" ? "selected" : ""}>bolso</option>
          <option value="valija" ${v.equipaje==="valija" ? "selected" : ""}>valija</option>
          <option value="aconvenir" ${v.equipaje==="aconvenir" ? "selected" : ""}>a convenir</option>
        </select>

        <label class="muted">Detalles</label>
        <textarea id="comentario_${v.id}" maxlength="220">${(v.comentario ?? "").replace(/<\/textarea>/gi,"")}</textarea>

        <button class="green" onclick="guardarEdicion('${v.id}')">Guardar cambios</button>
      </div>
    `;

    cont.appendChild(div);
  }
}

/* ===============================
   setActivo ROBUSTO (evita "viaje no encontrado")
================================ */
async function setActivo(viajeId, activo) {
  let v = VIAJES_MAP.get(viajeId);

  // si no est√° en el map, lo buscamos directo en DB
  if (!v) {
    const { data, error } = await sb
      .from("viajes")
      .select("id, edit_token")
      .eq("id", viajeId)
      .single();

    if (error || !data) {
      alert("Viaje no encontrado");
      console.error(error);
      return;
    }
    v = data;
  }

  const { error } = await sb
    .from("viajes")
    .update({ activo })
    .eq("id", viajeId)
    .eq("edit_token", v.edit_token);

  if (error) {
    alert("Error actualizando publicaci√≥n");
    console.error(error);
    return;
  }

  await cargarMetricas();
  await cargarContactos();
}

function ocultarViaje(viajeId) {
  const ok = confirm("¬øOcultar el viaje del listado p√∫blico? (Se puede reactivar)");
  if (!ok) return;
  setActivo(viajeId, false);
}

function toggleEdit(viajeId) {
  const el = document.getElementById(`edit_${viajeId}`);
  el.style.display = (el.style.display === "none") ? "block" : "none";
}

async function guardarEdicion(viajeId) {
  const v = VIAJES_MAP.get(viajeId);
  if (!v) { alert("Viaje no encontrado"); return; }

  const fecha = document.getElementById(`fecha_${viajeId}`).value;
  const hora = document.getElementById(`hora_${viajeId}`).value;

  const horaAprox = document.getElementById(`aprox_${viajeId}`).checked;

  const asientos = parseInt(document.getElementById(`asientos_${viajeId}`).value, 10);
  const aConvenir = document.getElementById(`aconvenir_${viajeId}`).checked;
  const precio = aConvenir ? null : (parseInt(document.getElementById(`precio_${viajeId}`).value, 10) || null);

  const equipaje = document.getElementById(`equipaje_${viajeId}`).value || null;
  const comentario = document.getElementById(`comentario_${viajeId}`).value.trim() || null;

  if (!fecha || !hora) { alert("Complet√° fecha y hora"); return; }
  if (Number.isNaN(asientos) || asientos < 0) { alert("Asientos inv√°lidos"); return; }
  if (precio !== null && precio < 0) { alert("Precio inv√°lido"); return; }

  const fechaHoraISO = toLocalISOString(fecha, hora);

  const { error } = await sb
    .from("viajes")
    .update({
      fecha_hora: fechaHoraISO,
      hora_aprox: horaAprox,
      asientos,
      precio,
      equipaje,
      comentario
    })
    .eq("id", viajeId)
    .eq("edit_token", v.edit_token);

  if (error) {
    alert("Error guardando cambios");
    console.error(error);
    return;
  }

  await cargarMetricas();
  await cargarContactos();
}

/* ===============================
   INIT
================================ */
(async function init() {
  await cargarMetricas();
  await cargarContactos();
})();
</script>

</body>
</html>
